根据以下文档结合当前系统架构开发微信小程序的微信授权登录，并制定完整的开发计划。


# 小程序登录

小程序可以通过微信官方提供的登录能力方便地获取微信提供的用户身份标识，快速建立小程序内的用户体系。

## [](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E6%97%B6%E5%BA%8F)登录流程时序

![](https://res.wx.qq.com/wxdoc/dist/assets/img/api-login.2fcc9f35.jpg)

## [](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html#%E8%AF%B4%E6%98%8E)说明

1. 调用 [wx.login()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html) 获取 **临时登录凭证code** ，并回传到开发者服务器。
2. 调用 [auth.code2Session](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html) 接口，换取 **用户唯一标识 OpenID** 、 用户在微信开放平台账号下的**唯一标识UnionID**（若当前小程序已绑定到微信开放平台账号） 和 **会话密钥 session_key**。

之后开发者服务器可以根据用户标识来生成自定义登录态，用于后续业务逻辑中前后端交互时识别用户身份。

## [](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9)注意事项

1. 会话密钥 `session_key` 是对用户数据进行 [加密签名](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html) 的密钥。为了应用自身的数据安全，开发者服务器**不应该把会话密钥下发到小程序，也不应该对外提供这个密钥**。
2. 临时登录凭证 code 只能使用一次

# wx.login(Object object)

> **以 [Promise 风格](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/api.html#%E5%BC%82%E6%AD%A5-API-%E8%BF%94%E5%9B%9E-Promise) 调用**：不支持
> 
> **小程序插件**：支持，需要小程序基础库版本不低于 [2.3.1](https://developers.weixin.qq.com/miniprogram/analysis/experience/compatibility.html)
> 
> 在小程序插件中使用时，需要在用户信息功能页中获得用户授权或满足一定条件后调用。否则将返回 fail。详见 [用户信息功能页](https://developers.weixin.qq.com/miniprogram/dev/framework/plugin/functional-pages/user-info.html)
> 
> **微信 Windows 版**：支持
> 
> **微信 Mac 版**：支持
> 
> **微信 鸿蒙 OS 版**：支持

> 相关文档: [小程序登录](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)、[UnionID 机制说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html)、[接口调用频率规范](https://developers.weixin.qq.com/miniprogram/dev/framework/performance/api-frequency.html)

## [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0)功能描述

调用接口获取登录凭证（code）。通过凭证进而换取用户登录态信息，包括用户在当前小程序的唯一标识（openid）、微信开放平台账号下的唯一标识（unionid，若当前小程序已绑定到微信开放平台账号）及本次登录的会话密钥（session_key）等。用户数据的加解密通讯需要依赖会话密钥完成。

## [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#%E5%8F%82%E6%95%B0)参数

### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#Object-object)Object object

|属性|类型|默认值|必填|说明|最低版本|
|---|---|---|---|---|---|
|timeout|number||否|超时时间，单位ms|[1.9.90](https://developers.weixin.qq.com/miniprogram/analysis/experience/compatibility.html)|
|success|function||否|接口调用成功的回调函数||
|fail|function||否|接口调用失败的回调函数||
|complete|function||否|接口调用结束的回调函数（调用成功、失败都会执行）||

#### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#object-success-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0)object.success 回调函数

##### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#%E5%8F%82%E6%95%B0-2)参数

###### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#Object-res)Object res

|属性|类型|说明|
|---|---|---|
|code|string|用户登录凭证（有效期五分钟）。开发者需要在开发者服务器后台调用 [code2Session](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html)，使用 code 换取 openid、unionid、session_key 等信息|

#### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#object-fail-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0)object.fail 回调函数

##### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#%E5%8F%82%E6%95%B0-3)参数

###### [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#Object-err)Object err

|属性|类型|说明|最低版本|
|---|---|---|---|
|errMsg|String|错误信息||
|errno|Number|errno 错误码，错误码的详细说明参考 [Errno错误码](https://developers.weixin.qq.com/miniprogram/dev/framework/usability/PublicErrno.html)|[2.24.0](https://developers.weixin.qq.com/miniprogram/analysis/experience/compatibility.html)|

## [](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81)示例代码

```js
wx.login({
  success (res) {
    if (res.code) {
      //发起网络请求
      wx.request({
        url: 'https://example.com/onLogin',
        data: {
          code: res.code
        }
      })
    } else {
      console.log('登录失败！' + res.errMsg)
    }
  }
})
```


# code2Session接口

 [调试工具](https://developers.weixin.qq.com/apiExplorer?apiName=code2Session&plat=miniprogram)

> 接口应在服务器端调用，详细说明参见[服务端API](https://developers.weixin.qq.com/miniprogram/dev/framework/server-ability/backend-api.html)。

## [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E)接口说明

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E6%8E%A5%E5%8F%A3%E8%8B%B1%E6%96%87%E5%90%8D)接口英文名

code2Session

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0)功能描述

登录凭证校验。通过 wx.login 接口获得临时登录凭证 code 后传到开发者服务器调用此接口完成登录流程。更多使用方法详见[小程序登录。](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)

## [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F)调用方式

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#HTTPS-%E8%B0%83%E7%94%A8)HTTPS 调用

```text

GET https://api.weixin.qq.com/sns/jscode2session 

```

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0)请求参数

|属性|类型|必填|说明|
|---|---|---|---|
|appid|string|是|小程序 appId|
|secret|string|是|小程序 appSecret|
|js_code|string|是|登录时获取的 code，可通过[wx.login](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)获取|
|grant_type|string|是|授权类型，此处只需填写 authorization_code|

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E8%BF%94%E5%9B%9E%E5%8F%82%E6%95%B0)返回参数

|属性|类型|说明|
|---|---|---|
|session_key|string|会话密钥|
|unionid|string|用户在开放平台的唯一标识符，若当前小程序已绑定到微信开放平台帐号下会返回，详见 [UnionID 机制说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html)。|
|errmsg|string|错误信息，请求失败时返回|
|openid|string|用户唯一标识|
|errcode|int32|错误码，请求失败时返回|

## [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E8%B0%83%E7%94%A8%E7%A4%BA%E4%BE%8B)调用示例

> 示例说明: HTTPS请求

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E7%A4%BA%E4%BE%8B)请求数据示例

```json

GET https://api.weixin.qq.com/sns/jscode2session?appid=APPID&secret=SECRET&js_code=JSCODE&grant_type=authorization_code 

```

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E7%A4%BA%E4%BE%8B)返回数据示例

```json

{
"openid":"xxxxxx",
"session_key":"xxxxx",
"unionid":"xxxxx",
"errcode":0,
"errmsg":"xxxxx"
}
 

```

### [](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html#%E9%94%99%E8%AF%AF%E7%A0%81)错误码

|错误码|错误描述|解决方案|
|---|---|---|
|40029|code 无效|js_code无效|
|45011|api minute-quota reach limit  mustslower  retry next minute|API 调用太频繁，请稍候再试|
|40226|code blocked|高风险等级用户，小程序登录拦截 。风险等级详见[用户安全解方案](https://developers.weixin.qq.com/miniprogram/dev/framework/operation.html)|
|-1|system error|系统繁忙，此时请开发者稍候再试|