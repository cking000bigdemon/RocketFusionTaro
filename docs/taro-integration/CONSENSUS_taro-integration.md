# Taro + Rocket 单仓库集成方案 - 最终共识文档

## 需求描述与验收标准

### 明确需求
在现有Rocket项目中集成Taro 3.x + React前端框架，实现Web、H5、微信小程序三端统一开发，采用单仓库完整打包部署模式。

### 技术方案确认

#### 1. 小程序配置
- **AppID**: 使用测试AppID (`touristappid`)
- **项目配置**: 支持正式AppID无缝切换

#### 2. UI组件库
- **选择**: Taro官方推荐组件库 `@tarojs/components`
- **版本**: 与Taro 3.x版本保持一致

#### 3. 状态管理
- **选择**: 轻量化方案 Zustand
- **优势**: 简洁API、TypeScript支持好、包体积小

#### 4. 样式方案
- **选择**: Tailwind CSS (推荐方案)
- **配置**: 支持小程序兼容模式
- **优化**: 生产环境自动PurgeCSS

#### 5. API路由设计
- **前缀**: 所有API统一使用 `/api/` 前缀
- **示例**: 
  - `GET /api/users` - 获取用户列表
  - `POST /api/auth/login` - 用户登录
  - `PUT /api/users/:id` - 更新用户信息

## 技术实现方案

### 架构设计
```
单仓库架构 (Monorepo)
├── Cargo.toml              # Rust后端配置
├── build.rs               # 构建集成脚本
├── Rocket.toml            # Rocket配置
├── src/                   # Rust后端源码
│   ├── main.rs           # 主程序入口
│   ├── api/              # API路由模块
│   └── models/           # 数据模型
├── frontend/              # Taro前端项目
│   ├── package.json      # 前端依赖
│   ├── config/           # Taro配置
│   │   ├── index.js      # 基础配置
│   │   ├── dev.js        # 开发配置
│   │   └── prod.js       # 生产配置
│   ├── src/              # React源码
│   │   ├── app.config.ts # 应用配置
│   │   ├── pages/        # 页面组件
│   │   ├── components/   # 通用组件
│   │   ├── stores/       # Zustand状态
│   │   └── utils/        # 工具函数
│   └── dist/             # 构建输出
├── static/               # 静态资源
│   ├── web/              # Web端构建产物
│   ├── h5/               # H5端构建产物
│   └── weapp/            # 小程序构建产物
└── .env                  # 环境变量
```

### 集成策略

#### 1. 构建集成
- **构建脚本**: `build.rs` 在编译时自动触发前端构建
- **构建流程**: 
  1. 检查Node.js环境
  2. 安装前端依赖
  3. 执行三端构建(Web/H5/小程序)
  4. 拷贝构建产物到static目录

#### 2. 静态文件服务
- **Rocket配置**: 使用`rocket_contrib::serve::StaticFiles`
- **路由策略**: 
  - `/` → Web端SPA
  - `/h5/` → H5端
  - `/api/` → API路由
  - 404回退到对应index.html

#### 3. 开发体验
- **并行开发**: 支持前后端独立开发
- **热重载**: Taro dev server + Rocket自动重启
- **环境切换**: 支持开发/测试/生产环境

### 技术约束

#### 1. 环境要求
- **Node.js**: >= 16.0.0
- **Rust**: >= 1.70.0
- **Taro CLI**: >= 3.6.0

#### 2. 构建限制
- **构建时间**: 首次构建约2-3分钟
- **产物大小**: Web端<500KB, H5端<300KB, 小程序<2MB
- **缓存策略**: 生产环境启用强缓存

#### 3. 兼容性
- **浏览器**: Chrome 60+, Safari 12+, Edge 79+
- **小程序**: 微信基础库 >= 2.20.0
- **移动端**: iOS 10+, Android 6+

## 任务边界限制

### 包含内容
- [ ] Taro项目初始化和配置
- [ ] 三端构建配置(Web/H5/小程序)
- [ ] Rocket静态文件服务配置
- [ ] 构建集成脚本(build.rs)
- [ ] 开发环境配置
- [ ] 基础API路由示例
- [ ] 部署文档和使用指南

### 不包含内容
- [ ] 小程序云开发配置
- [ ] 复杂业务逻辑实现
- [ ] 数据库集成(保持现有)
- [ ] 用户认证系统(仅提供示例)
- [ ] CDN配置和优化
- [ ] 监控和日志系统

## 验收标准

### 功能验收
- [ ] 项目可完整编译通过
- [ ] 支持Web端正常访问
- [ ] 支持H5端正常访问
- [ ] 支持微信小程序预览
- [ ] API路由正常工作
- [ ] 静态文件服务正常

### 质量验收
- [ ] 代码符合项目规范
- [ ] 提供完整文档
- [ ] 支持开发环境快速启动
- [ ] 支持生产环境优化构建
- [ ] 零配置开箱即用

### 文档验收
- [ ] 项目README完整
- [ ] 开发指南清晰
- [ ] 部署说明详细
- [ ] 故障排查指南

## 关键假设确认

1. ✅ **技术栈假设**: Taro 3.x + React + Zustand + Tailwind CSS
2. ✅ **部署假设**: 单仓库打包，Rocket提供静态服务
3. ✅ **开发假设**: 支持Windows开发环境
4. ✅ **性能假设**: 首次构建时间可接受
5. ✅ **维护假设**: 后续可独立升级前后端

## 风险与应对

### 技术风险
- **Node.js版本兼容性**: 使用.nvmrc锁定版本
- **构建时间**: 提供增量构建优化
- **小程序审核**: 使用测试AppID避免审核问题

### 集成风险
- **路径冲突**: 统一静态资源路径规范
- **缓存问题**: 生产环境使用文件哈希
- **环境变量**: 提供.env模板和验证脚本

---

**确认**: 所有需求已明确，技术方案已确定，可以进入架构设计阶段。