<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œçŠ¶æ€æ£€æµ‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            background: #f9f9f9;
        }
        .status-healthy { border-left: 4px solid #28a745; }
        .status-degraded { border-left: 4px solid #ffc107; }
        .status-unhealthy { border-left: 4px solid #dc3545; }
        .status-unknown { border-left: 4px solid #6c757d; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .result { 
            background: #f8f9fa; 
            padding: 12px; 
            border-radius: 4px; 
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
        pre { 
            background: #f1f3f4; 
            padding: 12px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸŒ ç½‘ç»œçŠ¶æ€æ£€æµ‹ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="status-card">
        <h3>ğŸš€ ç³»ç»Ÿæ¦‚è§ˆ</h3>
        <p>è¿™ä¸ªæµ‹è¯•é¡µé¢æ¼”ç¤ºäº†æ–°å®ç°çš„ç½‘ç»œçŠ¶æ€æ£€æµ‹åŠŸèƒ½ï¼š</p>
        <ul>
            <li>âœ… Rocketåç«¯æœåŠ¡çŠ¶æ€æ£€æµ‹</li>
            <li>âœ… æ•°æ®åº“è¿æ¥çŠ¶æ€ (PostgreSQL 192.168.5.222:5432)</li>
            <li>âœ… Redisç¼“å­˜çŠ¶æ€ (192.168.5.222:6379)</li>
            <li>âœ… å“åº”æ—¶é—´ç›‘æ§</li>
            <li>âœ… è¯¦ç»†é”™è¯¯ä¿¡æ¯å±•ç¤º</li>
        </ul>
    </div>

    <div class="status-card">
        <h3>ğŸ” APIæ¥å£æµ‹è¯•</h3>
        <button class="test-button" onclick="testHealthCheck()">æµ‹è¯•åŸºç¡€å¥åº·æ£€æŸ¥</button>
        <button class="test-button" onclick="testSystemHealth()">æµ‹è¯•ç³»ç»Ÿå¥åº·æ£€æŸ¥</button>
        <button class="test-button" onclick="testContinuously()">è¿ç»­ç›‘æ§ (30ç§’)</button>
        <button class="test-button" onclick="stopContinuousTest()">åœæ­¢ç›‘æ§</button>
        
        <div id="test-results"></div>
    </div>

    <div class="status-card">
        <h3>ğŸ“Š å®æ—¶çŠ¶æ€å±•ç¤º</h3>
        <div id="status-display">
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
        </div>
    </div>

    <script>
        let continuousTestInterval = null;
        
        async function testHealthCheck() {
            const resultsDiv = document.getElementById('test-results');
            const statusDiv = document.getElementById('status-display');
            
            try {
                resultsDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æ£€æµ‹åŸºç¡€å¥åº·çŠ¶æ€...</p>';
                
                const startTime = Date.now();
                const response = await fetch('http://127.0.0.1:8000/api/health');
                const responseTime = Date.now() - startTime;
                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    resultsDiv.innerHTML = `
                        <div class="result success">
                            <strong>âœ… åŸºç¡€å¥åº·æ£€æŸ¥æˆåŠŸ</strong><br>
                            å“åº”æ—¶é—´: ${responseTime}ms<br>
                            æ•´ä½“çŠ¶æ€: ${data.data.status}
                        </div>`;
                    
                    displayHealthStatus(data.data, 'basic');
                } else {
                    throw new Error(`APIè¿”å›é”™è¯¯: ${data.message || response.statusText}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <strong>âŒ åŸºç¡€å¥åº·æ£€æŸ¥å¤±è´¥</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>`;
            }
        }
        
        async function testSystemHealth() {
            const resultsDiv = document.getElementById('test-results');
            
            try {
                resultsDiv.innerHTML = '<p>ğŸ”„ æ­£åœ¨æ£€æµ‹ç³»ç»Ÿå¥åº·çŠ¶æ€...</p>';
                
                const startTime = Date.now();
                const response = await fetch('http://127.0.0.1:8000/api/metrics/health', {
                    method: 'POST'
                });
                const responseTime = Date.now() - startTime;
                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    resultsDiv.innerHTML = `
                        <div class="result success">
                            <strong>âœ… ç³»ç»Ÿå¥åº·æ£€æŸ¥æˆåŠŸ</strong><br>
                            å“åº”æ—¶é—´: ${responseTime}ms<br>
                            æ•´ä½“çŠ¶æ€: ${data.data.status}<br>
                            ç»„ä»¶æ•°é‡: ${data.data.components.length}
                        </div>`;
                    
                    displaySystemHealth(data.data);
                } else {
                    throw new Error(`APIè¿”å›é”™è¯¯: ${data.message || response.statusText}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <strong>âŒ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>`;
            }
        }
        
        async function testContinuously() {
            if (continuousTestInterval) {
                stopContinuousTest();
            }
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="result warning"><strong>ğŸ”„ å¼€å§‹è¿ç»­ç›‘æ§...</strong></div>';
            
            let testCount = 0;
            const maxTests = 30; // 30ç§’ï¼Œæ¯ç§’æµ‹è¯•ä¸€æ¬¡
            
            continuousTestInterval = setInterval(async () => {
                testCount++;
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/health');
                    const data = await response.json();
                    
                    const timestamp = new Date().toLocaleTimeString();
                    resultsDiv.innerHTML = `
                        <div class="result ${response.ok ? 'success' : 'error'}">
                            <strong>${response.ok ? 'âœ…' : 'âŒ'} ç›‘æ§ä¸­ (${testCount}/${maxTests})</strong><br>
                            æ—¶é—´: ${timestamp}<br>
                            çŠ¶æ€: ${response.ok ? data.data.status : 'è¿æ¥å¤±è´¥'}
                        </div>`;
                    
                    if (response.ok) {
                        displayHealthStatus(data.data, 'continuous');
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="result error">
                            <strong>âŒ è¿ç»­ç›‘æ§å¤±è´¥ (${testCount}/${maxTests})</strong><br>
                            é”™è¯¯: ${error.message}
                        </div>`;
                }
                
                if (testCount >= maxTests) {
                    stopContinuousTest();
                    resultsDiv.innerHTML += '<div class="result">ç›‘æ§å®Œæˆ</div>';
                }
            }, 1000);
        }
        
        function stopContinuousTest() {
            if (continuousTestInterval) {
                clearInterval(continuousTestInterval);
                continuousTestInterval = null;
            }
        }
        
        function displayHealthStatus(data, testType) {
            const statusDiv = document.getElementById('status-display');
            const timestamp = new Date().toLocaleTimeString();
            
            const getStatusClass = (status) => {
                switch(status) {
                    case 'healthy': return 'status-healthy';
                    case 'degraded': return 'status-degraded'; 
                    case 'unhealthy': return 'status-unhealthy';
                    default: return 'status-unknown';
                }
            };
            
            statusDiv.innerHTML = `
                <div class="${getStatusClass(data.status)}">
                    <h4>ğŸ¥ æœåŠ¡å™¨çŠ¶æ€ (${timestamp})</h4>
                    <p><strong>æ•´ä½“çŠ¶æ€:</strong> ${data.status}</p>
                    <p><strong>ç‰ˆæœ¬:</strong> ${data.version}</p>
                    
                    <h5>ğŸ–¥ï¸ RocketæœåŠ¡</h5>
                    <p>çŠ¶æ€: ${data.server.status} | åœ°å€: ${data.server.host}:${data.server.port}</p>
                    
                    <h5>ğŸ—„ï¸ æ•°æ®åº“ (PostgreSQL)</h5>
                    <p>
                        çŠ¶æ€: <span class="${data.database.connected ? 'success' : 'error'}">${data.database.status}</span> |
                        åœ°å€: ${data.database.host}:${data.database.port} |
                        å“åº”æ—¶é—´: ${data.database.response_time_ms}ms
                        ${data.database.error ? '<br><span class="error">é”™è¯¯: ' + data.database.error + '</span>' : ''}
                    </p>
                    
                    <h5>âš¡ Redisç¼“å­˜</h5>
                    <p>
                        çŠ¶æ€: <span class="${data.cache.connected ? 'success' : 'error'}">${data.cache.status}</span> |
                        åœ°å€: ${data.cache.host}:${data.cache.port} |
                        å“åº”æ—¶é—´: ${data.cache.response_time_ms}ms
                        ${data.cache.error ? '<br><span class="error">é”™è¯¯: ' + data.cache.error + '</span>' : ''}
                    </p>
                </div>
                
                <details style="margin-top: 16px;">
                    <summary>ğŸ” æŸ¥çœ‹å®Œæ•´å“åº”æ•°æ®</summary>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </details>
            `;
        }
        
        function displaySystemHealth(data) {
            const statusDiv = document.getElementById('status-display');
            const timestamp = new Date().toLocaleTimeString();
            
            const componentsHtml = data.components.map(comp => `
                <div style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <strong>${comp.name}</strong>: 
                    <span class="${comp.status === 'healthy' ? 'success' : 'error'}">${comp.status}</span>
                    ${comp.details ? `<br><small>${comp.details}</small>` : ''}
                </div>
            `).join('');
            
            statusDiv.innerHTML = `
                <div class="status-${data.status}">
                    <h4>ğŸ¥ ç³»ç»Ÿå¥åº·çŠ¶æ€ (${timestamp})</h4>
                    <p><strong>æ•´ä½“çŠ¶æ€:</strong> ${data.status}</p>
                    <p><strong>ç‰ˆæœ¬:</strong> ${data.version}</p>
                    <p><strong>æ£€æŸ¥æ—¶é—´:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                    
                    <h5>ğŸ”§ ç³»ç»Ÿç»„ä»¶</h5>
                    ${componentsHtml}
                </div>
                
                <details style="margin-top: 16px;">
                    <summary>ğŸ” æŸ¥çœ‹å®Œæ•´å“åº”æ•°æ®</summary>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </details>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡åŸºç¡€æ£€æŸ¥
        window.onload = function() {
            setTimeout(testHealthCheck, 500);
        };
    </script>
</body>
</html>